# =============================================================================
# Release Workflow - Automated Release from Tag Push
# =============================================================================
# Triggered when a version tag (v*) is pushed.
# This workflow:
#   1. Extracts release notes from CHANGELOG.md for the tagged version
#   2. Creates a GitHub Release with those notes
#   3. Builds the release APK and attaches it to the release
#   4. Deploys the web build to GitHub Pages
#
# Usage:
#   1. Update version in pubspec.yaml and CHANGELOG.md
#   2. Commit and push
#   3. git tag v1.2.0 && git push origin v1.2.0
#   4. Everything else happens automatically
# =============================================================================

name: Release

on:
  push:
    tags:
      - 'v*'

# Only one release workflow should run at a time
concurrency:
  group: release
  cancel-in-progress: false

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  # ===========================================================================
  # Job 1: Create GitHub Release from CHANGELOG.md
  # ===========================================================================
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Get version from tag
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Extract changelog for this version
        id: changelog
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          # Extract the section for this version from CHANGELOG.md
          # Matches from "## X.Y.Z" until the next "## " or end of file
          NOTES=$(awk "/^## ${VERSION}/{flag=1; next} /^## /{flag=0} flag" CHANGELOG.md)
          if [ -z "$NOTES" ]; then
            NOTES="Release ${GITHUB_REF#refs/tags/}"
          fi
          # Write to file to preserve formatting
          echo "$NOTES" > /tmp/release_notes.md

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ steps.version.outputs.version }}" \
            --title "${{ steps.version.outputs.version }}" \
            --notes-file /tmp/release_notes.md

  # ===========================================================================
  # Job 2: Build Release APK and attach to GitHub Release
  # ===========================================================================
  release-apk:
    name: Build & Upload Release APK
    runs-on: ubuntu-latest
    needs: create-release

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Java 17
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Cache Gradle dependencies
        uses: actions/cache@v5
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('android/gradle/wrapper/gradle-wrapper.properties', 'android/**/build.gradle.kts') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      - name: Cache pub dependencies
        uses: actions/cache@v5
        with:
          path: |
            ~/.pub-cache
            .dart_tool/
          key: pub-cache-${{ runner.os }}-${{ hashFiles('pubspec.lock') }}
          restore-keys: |
            pub-cache-${{ runner.os }}-

      - name: Decode release keystore
        if: env.KEYSTORE_BASE64 != ''
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: echo "$KEYSTORE_BASE64" | base64 -d > android/french_keystore.jks

      - name: Install dependencies
        run: flutter pub get

      - name: Build release APK
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: flutter build apk --release

      - name: Rename APK with version
        run: |
          VERSION="${{ needs.create-release.outputs.version }}"
          cp build/app/outputs/flutter-apk/app-release.apk \
             build/app/outputs/flutter-apk/parler-${VERSION}.apk

      - name: Upload APK to GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ needs.create-release.outputs.version }}"
          gh release upload "${VERSION}" \
            "build/app/outputs/flutter-apk/parler-${VERSION}.apk" \
            --clobber

      - name: Upload APK artifact
        uses: actions/upload-artifact@v6
        with:
          name: release-apk
          path: build/app/outputs/flutter-apk/app-release.apk
          retention-days: 90

  # ===========================================================================
  # Job 3: Build Web and deploy to GitHub Pages
  # ===========================================================================
  release-web:
    name: Build & Deploy Web to GitHub Pages
    runs-on: ubuntu-latest
    needs: create-release

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Cache pub dependencies
        uses: actions/cache@v5
        with:
          path: |
            ~/.pub-cache
            .dart_tool/
          key: pub-cache-${{ runner.os }}-${{ hashFiles('pubspec.lock') }}
          restore-keys: |
            pub-cache-${{ runner.os }}-

      - name: Install dependencies
        run: flutter pub get

      - name: Build web for GitHub Pages
        run: |
          REPO_NAME="${{ github.event.repository.name }}"
          flutter build web --release --base-href "/${REPO_NAME}/"

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: build/web
          force_orphan: true
          commit_message: "deploy: release ${{ needs.create-release.outputs.version }}"

      - name: Upload web build artifact
        uses: actions/upload-artifact@v6
        with:
          name: release-web
          path: build/web/
          retention-days: 90
